# Детекторы паттернов

## Обзор

Модуль содержит 8 детекторов для обнаружения различных торговых паттернов на криптовалютных рынках. Каждый детектор реализует интерфейс `BaseDetector` и может быть настроен через конфигурационный файл.

## Прогресс-логирование

Все детекторы поддерживают отслеживание прогресса выполнения:

### Автоматическое логирование
- **Этап 1/3**: Валидация данных
- **Этап 2/3**: Анализ паттернов  
- **Этап 3/3**: Завершение с итоговой статистикой

### Детальный прогресс
- **По биржам**: каждые 5 бирж выводится статус
- **По временным группам**: каждые 100 групп (debug уровень)
- **Время выполнения**: для каждого детектора и общего процесса

### Методы детекции
```python
# Обычная детекция
events = detector.detect(data)

# Детекция с прогресс-логированием (рекомендуется)
events = detector.detect_with_progress(data)

# Запуск всех детекторов с прогрессом
results = run_detectors(detectors, data, use_progress=True)
```

## Детекторы

### D1 — Вакуум ликвидности
**Суть**: Исчезновение заявок в стакане, цена прыгает через пустое место.

**Признаки**:
- В стакане на 1–3 уровнях подряд нет заявок (объем ≈ 0)
- Цена проскочила за 1 тик/1 секунду > X пунктов
- Объем сделок в момент скачка выше среднего

**Параметры**:
- `empty_levels`: количество пустых уровней (по умолчанию: 3)
- `min_jump_ticks`: минимальный скачок в тиках (по умолчанию: 5)
- `time_window_ms`: временное окно анализа в мс (по умолчанию: 1000)
- `min_volume_ratio`: минимальное соотношение объема (по умолчанию: 2.0)

### D2 — Перелом на поглощении
**Суть**: Одна сторона активно давит рынок, но цена не движется.

**Признаки**:
- В ленте >70% сделок на продажу (или покупку)
- Цена не смещается более чем на Y тиков
- Видна крупная заявка в стакане, которую постоянно бьют, но она остается

**Параметры**:
- `min_side_ratio`: минимальная доля одной стороны (по умолчанию: 0.7)
- `max_price_move_ticks`: максимальное движение цены в тиках (по умолчанию: 2)
- `min_total_volume`: минимальный общий объем (по умолчанию: 100)
- `persistent_order_threshold`: порог стойкости заявки (по умолчанию: 50)

### D3 — Тающий айсберг
**Суть**: Скрытая крупная заявка, разбитая на маленькие куски.

**Признаки**:
- По одной цене за короткий промежуток времени исполняется >N сделок
- Совокупный объём >> среднего для рынка
- В стакане заявка «обновляется» после каждого удара

**Параметры**:
- `same_price_trades`: количество сделок по одной цене (по умолчанию: 10)
- `time_window_ms`: временное окно в мс (по умолчанию: 2000)
- `min_total_volume`: минимальный общий объем (по умолчанию: 200)
- `refresh_detect`: включить детекцию обновлений (по умолчанию: true)

### D4 — Продолжение после выноса стопов
**Суть**: Цена пробивает уровень стопов и продолжает движение.

**Признаки**:
- Резкий всплеск цены (например, >0.3% за ≤2 сек)
- Рост объема в ленте и сохранение направления
- Отсутствие возврата в диапазон в течение N секунд

**Параметры**:
- `min_price_move_percent`: минимальное движение цены в % (по умолчанию: 0.3)
- `time_window_ms`: временное окно в мс (по умолчанию: 2000)
- `no_pullback_window_ms`: окно проверки возврата в мс (по умолчанию: 5000)
- `min_volume_ratio`: минимальное соотношение объема (по умолчанию: 3.0)

### D5 — Ложный вынос стопов
**Суть**: Цена выбивает стопы, но сразу возвращается.

**Признаки**:
- Цена пробивает локальный экстремум
- В течение ≤5 секунд возврат на ≥70% движения
- В ленте фиксируются крупные сделки в обратную сторону

**Параметры**:
- `break_extreme_confirm_ticks`: подтверждение пробития в тиках (по умолчанию: 2)
- `reversal_window_ms`: окно возврата в мс (по умолчанию: 5000)
- `reversal_threshold_ratio`: порог возврата (по умолчанию: 0.7)
- `opposite_large_trade`: требовать крупные сделки в обратную сторону (по умолчанию: true)

### D6 — Сильный перекос стакана
**Суть**: Одна сторона стакана многократно перевешивает другую.

**Признаки**:
- Сумма объёмов топ-5 bid >> топ-5 ask (или наоборот) в X раз
- Объем на одном уровне > средней стены в Y раз
- Нет мгновенного снятия этой заявки

**Параметры**:
- `bid_ask_ratio`: соотношение bid/ask (по умолчанию: 3.0)
- `level_wall_multiplier`: множитель стены (по умолчанию: 5.0)
- `levels_depth`: глубина анализа уровней (по умолчанию: 5)

### D7 — Спуфинг ловушка
**Суть**: Крупная заявка размещается и быстро снимается для манипуляции.

**Признаки**:
- Крупная заявка размещается близко к рынку
- Быстро снимается (≤1 секунда)
- Не исполняется или исполняется минимально

**Параметры**:
- `large_order_multiplier`: множитель крупной заявки (по умолчанию: 5.0)
- `distance_ticks`: расстояние от рынка в тиках (по умолчанию: 2)
- `cancel_time_window_ms`: окно снятия в мс (по умолчанию: 1000)
- `no_trade_executed`: требовать отсутствия исполнения (по умолчанию: true)

### D8 — Разгон на импульсе
**Суть**: Движение ускоряется за счёт толпы.

**Признаки**:
- Свеча/тик движется с растущей скоростью (ускорение)
- Объём сделок за секунду в 3–5 раз выше среднего
- Кол-во рыночных ордеров в одном направлении >80%

**Параметры**:
- `acceleration_window_ms`: окно анализа ускорения в мс (по умолчанию: 3000)
- `min_volume_ratio`: минимальное соотношение объема (по умолчанию: 3.0)
- `one_side_ratio`: доля одной стороны (по умолчанию: 0.8)
- `candle_body_ratio`: соотношение тела свечи (по умолчанию: 0.7)

## Использование

```python
from oflow.blocks.detectors import create_detectors_from_config, run_detectors
import yaml

# Загрузка конфигурации
with open('configs/detectors.yaml', 'r') as f:
    config = yaml.safe_load(f)

# Создание детекторов
detectors = create_detectors_from_config(config)

# Запуск детекции с прогресс-логированием
results = run_detectors(detectors, data, use_progress=True)
```

## Структура событий

Каждый детектор возвращает DataFrame с событиями, содержащий:
- `ts_ns`: временная метка события
- `exchange`: биржа
- `pattern_type`: тип паттерна
- `confidence`: уверенность в паттерне (0-1)
- `metadata`: дополнительные данные паттерна

## Логирование

### Уровни логирования
- **INFO**: Основные этапы детекции и прогресс по биржам
- **DEBUG**: Детальный прогресс по временным группам
- **WARNING**: Проблемы с данными
- **ERROR**: Ошибки выполнения

### Пример вывода
```
=== Начало детекции D1LiquidityVacuumBreak ===
Этап 1/3: Валидация данных...
Валидация данных пройдена успешно
Этап 2/3: Анализ паттернов...
Обрабатываем 5 бирж...
Прогресс: 5/5 бирж
Этап 3/3: Завершено за 2.34с, найдено 12 событий
=== Детекция D1LiquidityVacuumBreak завершена ===
```
