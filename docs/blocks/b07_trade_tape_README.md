# Блок 07: Лента сделок

## Обзор

Модуль анализа ленты сделок (Trade Tape) предназначен для определения стороны агрессии, вычисления объемов по временным окнам и расчета дополнительных метрик торговой активности.

## Функциональность

### 1. Анализ агрессии
- **Определение агрессора**: анализ каждой сделки на предмет агрессивности
- **Типы агрессии**:
  - `aggressive_buy/sell` - агрессивная покупка/продажа (цена движется в сторону сделки)
  - `moderate_buy/sell` - умеренная агрессия (цена остается на том же уровне)
  - `passive_buy/sell` - пассивная сделка (цена движется против сделки)
- **Скоринг агрессии**: числовая оценка от 0.0 до 1.0

### 2. Объемы по временным окнам
- **Короткое окно**: 1 секунда (1000 мс)
- **Среднее окно**: 10 секунд (10000 мс)
- **Длинное окно**: 1 минута (60000 мс)
- **Дополнительное окно**: 5 минут (300000 мс)

### 3. Дополнительные метрики
- **VWAP**: Volume Weighted Average Price
- **Trade Flow Imbalance**: дисбаланс торгового потока
- **Large Trades Ratio**: доля крупных сделок
- **Волатильность**: скользящее стандартное отклонение цены

## Структура данных

### Входные данные
```python
trades_df = pd.DataFrame({
    'ts_ns': int,           # Временная метка в наносекундах
    'exchange': str,         # Биржа
    'symbol': str,           # Символ
    'side': str,             # Сторона (buy/sell)
    'price': float,          # Цена сделки
    'size': float            # Размер сделки
})
```

### Выходные данные
```python
# Основные колонки агрессии
'aggression_type': str,      # Тип агрессии
'aggression_score': float,   # Скоринг агрессии (0-1)
'aggressor_side': str,       # Сторона агрессора

# Объемы по окнам
'volume_short_1000ms': float,    # Объем за 1 секунду
'speed_short_1000ms': float,     # Скорость торгов за 1 секунду
'cumulative_short_1000ms': float, # Кумулятивный объем

# Дополнительные метрики
'vwap': float,                    # VWAP
'trade_flow_imbalance': float,    # Дисбаланс торгового потока
'large_trades_ratio': float,      # Доля крупных сделок
'volatility': float               # Волатильность
```

## Использование

### Базовое использование
```python
from oflow.blocks.trade_tape import run_trade_tape
import yaml

# Загрузка конфигурации
with open('configs/trade_tape.yaml', 'r') as f:
    config = yaml.safe_load(f)

# Анализ ленты сделок
analyzed_tape = run_trade_tape(trades_df, config)
```

### Продвинутое использование
```python
from oflow.blocks.trade_tape import TradeTapeAnalyzer

# Создание анализатора
analyzer = TradeTapeAnalyzer(config)

# Полный анализ с прогресс-логированием
tape_df = analyzer.analyze_trade_tape(trades_df)
```

## Конфигурация

### Основные параметры
```yaml
# Временные окна
windows:
  short: 1000      # 1 секунда
  medium: 10000     # 10 секунд
  long: 60000       # 1 минута

# Настройки агрессии
aggression:
  threshold: 0.6           # Порог агрессивности
  min_trades_for_analysis: 10  # Минимум сделок для анализа

# Настройки объемов
volumes:
  large_trade_multiplier: 2.0  # Множитель крупных сделок
```

## Алгоритмы

### Определение агрессии
1. **Сравнение цен**: текущая цена vs предыдущая сделка
2. **Анализ стороны**: buy/sell + направление движения цены
3. **Классификация**:
   - Агрессивная: цена движется в сторону сделки
   - Умеренная: цена остается на том же уровне
   - Пассивная: цена движется против сделки

### Вычисление объемов
1. **Временные окна**: скользящие окна для каждого уровня
2. **Кумулятивные объемы**: накопительная сумма по времени
3. **Скорость торгов**: объем в единицу времени

### Дополнительные метрики
1. **VWAP**: взвешенная по объему средняя цена
2. **Trade Flow Imbalance**: (buy_volume - sell_volume) / total_volume
3. **Волатильность**: стандартное отклонение цены в окне

## Экспорт данных

### Основные файлы
- `tape_analyzed.parquet` - полная проанализированная лента сделок
- `exchange_summary.parquet` - агрегация по биржам
- `hourly_summary.parquet` - агрегация по часам
- `aggression_summary.parquet` - агрегация по типам агрессии

### Формат данных
- **Parquet** с сжатием Snappy
- **Индексация** по времени и бирже
- **Оптимизация** для быстрого чтения

## Производительность

### Оптимизации
- **Векторизованные операции** pandas/numpy
- **Группировка по биржам** для параллельной обработки
- **Скользящие окна** с эффективными алгоритмами
- **Пакетная обработка** больших объемов данных

### Ограничения
- **Память**: требует загрузки всей ленты сделок в память
- **Время**: O(n * w) где n - количество сделок, w - количество окон
- **Диск**: для больших объемов данных требуется значительное место

## Примеры использования

### Анализ агрессии по бирже
```python
# Фильтрация агрессивных сделок
aggressive_trades = analyzed_tape[
    analyzed_tape['aggression_type'].str.contains('aggressive')
]

# Статистика по биржам
aggression_by_exchange = aggressive_trades.groupby('exchange').agg({
    'aggression_score': 'mean',
    'size': 'sum',
    'trade_value': 'sum'
})
```

### Анализ объемов по времени
```python
# Объемы по часам
hourly_volumes = analyzed_tape.groupby(['exchange', 'date', 'hour']).agg({
    'volume_short_1000ms': 'mean',
    'volume_medium_10000ms': 'mean',
    'volume_long_60000ms': 'mean'
})
```

### Выявление крупных сделок
```python
# Крупные сделки
large_trades = analyzed_tape[
    analyzed_tape['large_trades_ratio'] > 0.1
]

# Анализ влияния на цену
price_impact = large_trades.groupby('aggression_type').agg({
    'price_change_pct': 'mean',
    'size': 'sum'
})
```

## Логирование

### Уровни логирования
- **INFO**: основные этапы анализа
- **DEBUG**: детальный прогресс по временным группам
- **WARNING**: проблемы с данными
- **ERROR**: ошибки выполнения

### Прогресс-логирование
- **По биржам**: каждые 3 биржи
- **По этапам**: 4 основных этапа анализа
- **Время выполнения**: для каждого этапа и общего процесса
