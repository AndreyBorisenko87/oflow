# Блок 10: Фичи паттернов для детекторов

## Обзор

Модуль извлечения фич паттернов предназначен для подготовки признаков, необходимых нашим 8 детекторам паттернов (D1-D8). Это **сердце конвейера**, которое превращает "сырые данные стакана и сделок" в структурированные торговые признаки, пригодные для поиска закономерностей и генерации сигналов.

## Зачем нужен блок 10

### Проблема сырых данных
- **Сырые данные** = миллионы записей про каждое изменение стакана и каждую сделку
- В таком виде они слишком шумные и "низкоуровневые"
- Непригодны для ML или статистического анализа

### Решение - структурированные фичи
- **Фичи** = концентрированные сигналы: "в этом окне было много отмен", "уровень быстро опустел", "появился refill"
- Блок "сжимает" хаос в информативные события
- Подготавливает данные для кластеризации паттернов и тестирования стратегий

## Наши 8 детекторов (D1-D8)

### D1 — Вакуум ликвидности
**Признаки для детектора:**
- `d1_vacuum_score` - скоринг вакуума (0-1)
- `d1_empty_levels` - количество пустых уровней
- `d1_liquidity_depth` - глубина ликвидности

**Логика:** Анализ пустых уровней в стакане и глубины ликвидности

### D2 — Перелом на поглощении
**Признаки для детектора:**
- `d2_side_ratio` - доля сделок одной стороны
- `d2_price_stable` - стабильность цены (bool)

**Логика:** Анализ дисбаланса сделок при стабильной цене

### D3 — Тающий айсберг
**Признаки для детектора:**
- `d3_same_price_count` - количество сделок по одной цене
- `d3_volume_concentration` - концентрация объема

**Логика:** Анализ концентрации сделок по ценам

### D4 — Продолжение после выноса стопов
**Признаки для детектора:**
- `d4_price_momentum` - импульс цены
- `d4_volume_surge` - всплеск объема

**Логика:** Анализ импульса цены и всплесков объема

### D5 — Ложный вынос стопов
**Признаки для детектора:**
- `d5_reversal_probability` - вероятность разворота

**Логика:** Анализ соотношения отмен vs добавлений заявок

### D6 — Сильный перекос стакана
**Признаки для детектора:**
- `d6_bid_ask_imbalance` - дисбаланс bid/ask
- `d6_level_wall` - множитель стены на уровне

**Логика:** Анализ дисбаланса объемов bid/ask и стен на уровнях

### D7 — Спуфинг ловушка
**Признаки для детектора:**
- `d7_spoofing_score` - скоринг спуфинга
- `d7_quick_cancel` - быстрая отмена (bool)

**Логика:** Анализ быстрых отмен крупных заявок

### D8 — Разгон на импульсе
**Признаки для детектора:**
- `d8_momentum_score` - скоринг импульса
- `d8_acceleration` - ускорение цены
- `d8_volume_surge` - всплеск объема

**Логика:** Анализ ускорения цены и всплесков объема

## Структура данных

### Входные данные

#### Стакан заявок (book_df)
```python
book_df = pd.DataFrame({
    'ts_ns': int,           # Временная метка в наносекундах
    'exchange': str,         # Биржа
    'symbol': str,           # Символ
    'side': str,             # Сторона (bid/ask)
    'price': float,          # Цена уровня
    'size': float,           # Размер заявки
    'action': str            # Действие (add/delete/update)
})
```

#### Лента сделок (trades_df)
```python
trades_df = pd.DataFrame({
    'ts_ns': int,           # Временная метка в наносекундах
    'exchange': str,         # Биржа
    'symbol': str,           # Символ
    'price': float,          # Цена сделки
    'size': float,           # Размер сделки
    'side': str              # Сторона (buy/sell)
})
```

#### Котировки (quotes_df)
```python
quotes_df = pd.DataFrame({
    'ts_ns': int,           # Временная метка в наносекундах
    'exchange': str,         # Биржа
    'symbol': str,           # Символ
    'bid': float,            # Лучшая цена покупки
    'ask': float,            # Лучшая цена продажи
    'bid_size': float,       # Объем bid
    'ask_size': float        # Объем ask
})
```

### Выходные данные

#### Признаки для детекторов (features_df)
```python
# Основные метрики
'ts_ns': int,                     # Временная метка
'ts_group': int,                  # Временная группа
'exchange': str,                  # Биржа
'symbol': str,                     # Символ

# Order Flow признаки
'cancellation_rate': float,        # Доля отмен заявок
'addition_rate': float,            # Доля добавлений заявок
'bid_ask_imbalance': float,        # Дисбаланс bid/ask
'total_volume': float,             # Суммарный объем

# D1: Вакуум ликвидности
'd1_vacuum_score': float,          # Скоринг вакуума (0-1)
'd1_empty_levels': int,            # Количество пустых уровней
'd1_liquidity_depth': float,       # Глубина ликвидности

# D2: Поглощение
'd2_side_ratio': float,            # Доля одной стороны
'd2_price_stable': bool,           # Стабильность цены

# D3: Айсберг
'd3_same_price_count': int,        # Сделки по одной цене
'd3_volume_concentration': float,  # Концентрация объема

# D4: Стоп-ран
'd4_price_momentum': float,        # Импульс цены
'd4_volume_surge': float,          # Всплеск объема

# D5: Ложный вынос
'd5_reversal_probability': float,  # Вероятность разворота

# D6: Имбаланс стакана
'd6_bid_ask_imbalance': float,    # Дисбаланс bid/ask
'd6_level_wall': float,            # Множитель стены

# D7: Спуфинг
'd7_spoofing_score': float,        # Скоринг спуфинга
'd7_quick_cancel': bool,           # Быстрая отмена

# D8: Импульс
'd8_momentum_score': float,        # Скоринг импульса
'd8_acceleration': float,          # Ускорение цены
'd8_volume_surge': float,          # Всплеск объема

# Скоринги детекторов
'd1_score': float,                 # Скоринг D1
'd2_score': float,                 # Скоринг D2
'd3_score': float,                 # Скоринг D3
'd4_score': float,                 # Скоринг D4
'd5_score': float,                 # Скоринг D5
'd6_score': float,                 # Скоринг D6
'd7_score': float,                 # Скоринг D7
'd8_score': float,                 # Скоринг D8

# Общие метрики
'overall_detector_score': float,   # Общий скоринг всех детекторов
'primary_detector': str            # Основной детектор
```

## Использование

### Базовое использование
```python
from oflow.blocks.features import run_features
import yaml

# Загрузка конфигурации
with open('configs/features.yaml', 'r') as f:
    config = yaml.safe_load(f)

# Извлечение признаков для детекторов
features_df = run_features(book_df, trades_df, quotes_df, config)
```

### Продвинутое использование
```python
from oflow.blocks.features import DetectorFeatureExtractor

# Создание извлекателя
extractor = DetectorFeatureExtractor(config)

# Полное извлечение признаков с прогресс-логированием
features_df = extractor.run_feature_extraction(book_df, trades_df, quotes_df)
```

## Алгоритмы извлечения

### 1. Валидация и подготовка данных
- Проверка обязательных колонок для каждого типа данных
- Сортировка по временным меткам
- Группировка по тикам для синхронизации
- Graceful handling отсутствующих данных

### 2. Базовые Order Flow признаки
- Агрегация add/delete/update по сторонам bid/ask
- Вычисление долей операций
- Дисбалансы bid/ask по добавлениям и отменам
- Объемные метрики

### 3. Признаки для D1 (Вакуум)
- Анализ глубины ликвидности
- Подсчет пустых уровней < threshold
- Нормализованный скоринг: empty_ratio * 0.7 + depth_ratio * 0.3

### 4. Признаки для D2-D4 (Поглощение, Айсберг, Стоп-ран)
- D2: Анализ дисбаланса сделок при стабильной цене
- D3: Концентрация сделок по ценам
- D4: Импульс цены и всплески объема

### 5. Признаки для D5-D7 (Ложный вынос, Имбаланс, Спуфинг)
- D5: Соотношение отмен vs добавлений
- D6: Дисбаланс объемов bid/ask и стены на уровнях
- D7: Анализ быстрых отмен крупных заявок

### 6. Признаки для D8 (Импульс)
- Анализ ускорения цены
- Всплески объема
- Комбинированный скоринг импульса

## Экспорт данных

### Основные файлы
- `detector_features.parquet` - полные признаки для детекторов
- `detector_exchange_summary.parquet` - сводка по биржам
- `detector_pattern_summary.parquet` - сводка по детекторам
- `detector_hourly_summary.parquet` - почасовая агрегация

### Формат данных
- **Parquet** с сжатием Snappy
- **Индексация** по времени, бирже и символам
- **Оптимизация** для быстрого чтения детекторами

## Интеграция с детекторами

### Подготовка данных для D1 (LVB)
```python
# Фильтрация по вакууму
lvb_candidates = features_df[
    (features_df['d1_vacuum_score'] > 0.6) &
    (features_df['d1_empty_levels'] >= 3)
]

# Дополнительные признаки для LVB
lvb_features = lvb_candidates[['d1_vacuum_score', 'd1_empty_levels', 'd1_liquidity_depth']]
```

### Подготовка данных для D2 (Absorption)
```python
# Фильтрация по поглощению
absorption_candidates = features_df[
    (features_df['d2_side_ratio'] > 0.7) &
    (features_df['d2_price_stable'] == True)
]

# Дополнительные признаки для Absorption
absorption_features = absorption_candidates[['d2_side_ratio', 'd2_price_stable', 'total_volume']]
```

### Подготовка данных для D3 (Iceberg)
```python
# Фильтрация по айсбергу
iceberg_candidates = features_df[
    (features_df['d3_volume_concentration'] > 0.5) &
    (features_df['d3_same_price_count'] >= 10)
]

# Дополнительные признаки для Iceberg
iceberg_features = iceberg_candidates[['d3_volume_concentration', 'd3_same_price_count']]
```

## Производительность

### Оптимизации
- **Векторизованные операции** pandas/numpy
- **Временная группировка** для эффективной синхронизации
- **Пакетная обработка** больших объемов данных
- **Специализированные алгоритмы** для каждого детектора

### Ограничения
- **Память**: требует загрузки всех данных в память
- **Время**: O(n * g) где n - количество записей, g - количество групп
- **Синхронизация**: зависит от качества временных меток

## Логирование

### Уровни логирования
- **INFO**: основные этапы извлечения
- **DEBUG**: детальный прогресс по временным группам
- **WARNING**: проблемы с данными
- **ERROR**: ошибки выполнения

### Прогресс-логирование
- **По временным группам**: каждые 1000 групп
- **По этапам**: 6 основных этапов извлечения
- **Время выполнения**: для каждого этапа и общего процесса
- **Статистика**: количество записей и извлеченных признаков

## Ключевые преимущества

### 1. Снижение шума и избыточности
- Вместо 1000 строк изменений стакана за секунду получаем одно событие
- Концентрированные сигналы вместо сырых данных

### 2. Формализация паттернов
- Все ключевые микро-явления описываются через одинаковый набор численных признаков
- Унификация данных с разных бирж и рынков

### 3. Подготовка к ML
- Готовые признаки для кластеризации паттернов
- Классификация "сильный/слабый сигнал"
- Тестирование стратегий

### 4. Сердце конвейера
- Делает из тик-данных аналитические события
- Пригодно для поиска закономерностей и генерации сигналов
- Без этого блока невозможно работать с ML или статистикой
