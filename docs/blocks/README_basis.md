# Блок 09: Базис спот-фьючерс

## Обзор

Модуль анализа базиса спот-фьючерс предназначен для вычисления разницы цен между спотовым и фьючерсным рынками, обнаружения аномалий и анализа динамики базиса во времени.

## Функциональность

### 1. Синхронизация данных
- **Временная синхронизация**: выравнивание данных спот и фьючерс по времени
- **Валидация лагов**: проверка допустимых задержек между рынками
- **Сопоставление символов**: автоматическое определение соответствующих активов

### 2. Вычисление базиса
- **Абсолютный базис**: futures_price - spot_price
- **Относительный базис**: (basis_abs / spot_price) * 100%
- **Валидация данных**: проверка разумности вычисленных значений
- **Фильтрация**: отсев некорректных данных

### 3. Обнаружение аномалий
- **Скоринг аномалий**: числовая оценка от 0.0 до 1.0
- **Множественные факторы**: отклонения от MA, волатильность, резкие изменения
- **Пометки аномалий**: булевые флаги для дальнейшего анализа
- **Настраиваемые пороги**: гибкая настройка чувствительности

### 4. Дополнительные метрики
- **Скользящие средние**: для базиса (5, 10, 20, 50 периодов)
- **Волатильность**: стандартное отклонение базиса
- **Тренды**: направление изменения базиса
- **Категоризация**: контанго, бэквардация, паритет

## Структура данных

### Входные данные

#### Спотовые данные (spot_df)
```python
spot_df = pd.DataFrame({
    'ts_ns': int,           # Временная метка в наносекундах
    'exchange': str,         # Биржа
    'symbol': str,           # Символ (например, ETHUSDT)
    'price': float           # Цена спота
})
```

#### Фьючерсные данные (futures_df)
```python
futures_df = pd.DataFrame({
    'ts_ns': int,           # Временная метка в наносекундах
    'exchange': str,         # Биржа
    'symbol': str,           # Символ (например, ETHUSDT-PERP)
    'price': float           # Цена фьючерса
})
```

### Выходные данные

#### Анализированный базис (basis_df)
```python
# Основные метрики базиса
'ts_ns': int,                     # Временная метка
'spot_exchange': str,              # Биржа спота
'futures_exchange': str,           # Биржа фьючерса
'symbol': str,                     # Символ
'spot_price': float,               # Цена спота
'futures_price': float,            # Цена фьючерса
'basis_abs': float,                # Абсолютный базис
'basis_rel': float,                # Относительный базис (%)

# Скользящие средние
'basis_rel_ma_5': float,           # MA5 для относительного базиса
'basis_rel_ma_10': float,          # MA10 для относительного базиса
'basis_rel_ma_20': float,          # MA20 для относительного базиса
'basis_rel_ma_50': float,          # MA50 для относительного базиса
'basis_abs_ma_5': float,           # MA5 для абсолютного базиса
'basis_abs_ma_10': float,          # MA10 для абсолютного базиса
'basis_abs_ma_20': float,          # MA20 для абсолютного базиса
'basis_abs_ma_50': float,          # MA50 для абсолютного базиса

# Волатильность и аномалии
'basis_volatility': float,         # Волатильность базиса
'anomaly_score': float,            # Скоринг аномалий (0-1)
'anomaly_flag': bool,              # Флаг аномалии

# Дополнительные метрики
'basis_rel_change': float,         # Изменение относительного базиса
'basis_rel_change_pct': float,     # Изменение в процентах
'basis_trend': int,                # Тренд базиса (-1, 0, 1)
'convergence': float,              # Конвергенция к паритету
'basis_zscore': float,             # Z-score базиса
'basis_category': str               # Категория базиса
```

## Использование

### Базовое использование
```python
from oflow.blocks.basis import run_basis
import yaml

# Загрузка конфигурации
with open('configs/basis.yaml', 'r') as f:
    config = yaml.safe_load(f)

# Анализ базиса
basis_df = run_basis(spot_df, futures_df, config)
```

### Продвинутое использование
```python
from oflow.blocks.basis import BasisAnalyzer

# Создание анализатора
analyzer = BasisAnalyzer(config)

# Полный анализ с прогресс-логированием
basis_df = analyzer.run_basis_analysis(spot_df, futures_df)
```

## Конфигурация

### Основные параметры
```yaml
# Синхронизация
sync:
  max_lag_ms: 5000              # Максимальный лаг между рынками
  min_overlap_ratio: 0.8        # Минимальное перекрытие данных

# Базис
basis:
  max_basis_rel: 50.0           # Максимальный базис (%)
  min_basis_rel: -50.0          # Минимальный базис (%)

# Аномалии
anomaly:
  threshold: 2.0                # Порог аномалий
  volatility_threshold: 0.95    # Процентиль волатильности
```

## Алгоритмы

### Синхронизация данных
1. **Временные группы**: группировка по тикам времени
2. **Сопоставление символов**: автоматическое определение активов
3. **Валидация перекрытий**: проверка минимального покрытия

### Вычисление базиса
1. **Сопоставление по времени**: поиск соответствующих цен
2. **Проверка символов**: убрание суффиксов фьючерсов
3. **Вычисление разности**: абсолютный и относительный базис
4. **Валидация**: проверка разумности значений

### Обнаружение аномалий
1. **Отклонения от MA**: сравнение с скользящими средними
2. **Волатильность**: стандартные отклонения
3. **Резкие изменения**: анализ производных
4. **Комбинированный скоринг**: взвешенная сумма факторов

### Категоризация базиса
1. **Контанго**: futures > spot (положительный базис)
2. **Бэквардация**: futures < spot (отрицательный базис)
3. **Паритет**: futures ≈ spot (близкий к нулю)
4. **Сильные отклонения**: экстремальные значения

## Экспорт данных

### Основные файлы
- `basis_analyzed.parquet` - полный анализ базиса с метриками
- `exchange_basis_summary.parquet` - сводка по биржам
- `category_basis_summary.parquet` - сводка по категориям
- `hourly_basis_summary.parquet` - почасовая агрегация

### Формат данных
- **Parquet** с сжатием Snappy
- **Индексация** по времени и символам
- **Оптимизация** для быстрого чтения и анализа

## Производительность

### Оптимизации
- **Векторизованные операции** pandas/numpy
- **Временная группировка** для эффективной синхронизации
- **Пакетная обработка** больших объемов данных
- **Оптимизированные алгоритмы** для вычисления базиса

### Ограничения
- **Память**: требует загрузки всех данных в память
- **Время**: O(n * m) где n - спот записи, m - фьючерс записи
- **Синхронизация**: зависит от качества временных меток

## Примеры использования

### Анализ базиса по биржам
```python
# Сводка по биржам
exchange_analysis = basis_df.groupby(['spot_exchange', 'futures_exchange']).agg({
    'basis_rel': ['mean', 'std', 'min', 'max'],
    'anomaly_score': 'mean',
    'anomaly_flag': 'sum'
})
```

### Анализ категорий базиса
```python
# Фильтрация по категориям
contango_data = basis_df[basis_df['basis_category'] == 'contango']
backwardation_data = basis_df[basis_df['basis_category'] == 'backwardation']

# Статистика по категориям
category_stats = basis_df.groupby('basis_category').agg({
    'basis_rel': ['mean', 'std', 'count'],
    'anomaly_score': 'mean'
})
```

### Обнаружение аномалий
```python
# Высокие аномалии
high_anomalies = basis_df[basis_df['anomaly_score'] > 0.8]

# Аномалии по волатильности
volatility_anomalies = basis_df[
    basis_df['basis_volatility'] > basis_df['basis_volatility'].quantile(0.95)
]

# Комбинированный анализ
combined_anomalies = high_anomalies.merge(
    volatility_anomalies[['ts_ns', 'basis_volatility']],
    on='ts_ns',
    how='inner'
)
```

### Временной анализ
```python
# Тренды базиса
trend_analysis = basis_df.groupby('basis_trend').agg({
    'basis_rel': 'mean',
    'anomaly_score': 'mean',
    'basis_volatility': 'mean'
})

# Конвергенция к паритету
convergence_analysis = basis_df[basis_df['convergence'] == 1.0]
divergence_analysis = basis_df[basis_df['convergence'] == 0.0]
```

## Логирование

### Уровни логирования
- **INFO**: основные этапы анализа
- **DEBUG**: детальный прогресс по временным группам
- **WARNING**: проблемы с синхронизацией
- **ERROR**: ошибки выполнения

### Прогресс-логирование
- **По временным группам**: каждые 1000 групп
- **По этапам**: 4 основных этапа анализа
- **Время выполнения**: для каждого этапа и общего процесса
- **Статистика**: количество записей базиса и аномалий

## Торговые стратегии

### Контанго (futures > spot)
- **Стратегия**: продажа фьючерса, покупка спота
- **Риск**: падение базиса
- **Время**: до экспирации фьючерса

### Бэквардация (futures < spot)
- **Стратегия**: покупка фьючерса, продажа спота
- **Риск**: рост базиса
- **Время**: до экспирации фьючерса

### Арбитраж аномалий
- **Выявление**: высокий скоринг аномалий
- **Вход**: при превышении порога
- **Выход**: при нормализации базиса
