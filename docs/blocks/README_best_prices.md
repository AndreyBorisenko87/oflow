# Блок 05: Лучшие цены

## Обзор
Блок "Лучшие цены" восстанавливает best bid/ask/mid цены и спреды из depth данных с настраиваемым временным шагом. Это основа для построения NBBO (National Best Bid and Offer) и анализа рыночной ликвидности.

## Назначение
- **Восстановление quotes**: Извлечение best bid/ask из depth данных
- **Расчет спредов**: Абсолютные и относительные спреды
- **Временная агрегация**: Приведение к единому временному шагу
- **Валидация качества**: Проверка логичности и целостности данных

## Ключевые возможности

### 1. Восстановление best bid/ask
- Анализ depth данных по временным окнам
- Фильтрация активных уровней (size > 0)
- Поиск максимального bid и минимального ask
- Проверка логичности (bid < ask)

### 2. Расчет спредов и метрик
- Абсолютный спред в единицах цены
- Относительный спред в процентах
- Скользящие средние спредов
- Волатильность цен

### 3. Временная агрегация
- Настраиваемый шаг (по умолчанию 10мс)
- Методы агрегации: last, first, mean, median
- Заполнение пропусков: ffill, bfill, interpolate

### 4. Валидация качества
- Проверка монотонности цен
- Контроль разумности спредов
- Статистика по биржам
- Метрики качества восстановления

## Архитектура

### Основные функции
- `restore_quotes()` - Восстановление best bid/ask из depth
- `calculate_spreads()` - Расчет спредов и дополнительных метрик
- `aggregate_by_tick()` - Временная агрегация
- `validate_quotes()` - Валидация качества
- `save_quotes()` - Сохранение результатов
- `run_best_prices()` - Основная функция оркестрации

### Алгоритмы
1. **Временная группировка**: Создание buckets по настраиваемому шагу
2. **Поиск экстремумов**: Максимальный bid, минимальный ask
3. **Фильтрация**: Только активные уровни с size > 0
4. **Валидация**: Проверка bid < ask
5. **Агрегация**: Приведение к единому временному шагу

## Использование

### Базовый пример
```python
from oflow.blocks.best_prices import run_best_prices
import yaml
from pathlib import Path

# Загрузка конфигурации
with open('configs/best_prices.yaml', 'r') as f:
    config = yaml.safe_load(f)

# Запуск восстановления
quotes_df = run_best_prices(
    depth_df, config, Path("data/quotes")
)
```

### Конфигурация
```yaml
best_prices:
  tick_size_ms: 10
  min_bid_ask_spread: 0.0001
  require_both_sides: true
  log_progress: true
  spread_calculation:
    absolute: true
    relative: true
    rolling_window: 100
```

## Структура данных

### Входные данные
- `depth_df`: DataFrame с колонками `ts_ns`, `exchange`, `side`, `price`, `size`

### Выходные данные
- `quotes_df`: DataFrame с колонками:
  - `ts_ns`: Временная метка
  - `exchange`: Биржа
  - `best_bid`: Лучшая цена покупки
  - `best_ask`: Лучшая цена продажи
  - `mid`: Средняя цена
  - `spread`: Абсолютный спред
  - `spread_pct`: Относительный спред
  - `volatility`: Волатильность

## Метрики качества

### 1. Коэффициент восстановления
- Доля успешно восстановленных quotes от общего количества depth записей
- Цель: >80% для качественных данных

### 2. Качество спредов
- Проверка логичности (bid < ask)
- Контроль разумности размеров спредов
- Анализ аномалий

### 3. Временная непрерывность
- Покрытие временных интервалов
- Частота обновлений
- Стабильность временного шага

### 4. Статистика по биржам
- Количество quotes по биржам
- Распределение спредов
- Качество данных по источникам

## Производительность

### Оптимизации
- Батчевая обработка depth данных
- Эффективная группировка по времени
- Настраиваемые размеры пакетов

### Ограничения
- Требует достаточного количества depth данных
- Временная сложность: O(n log n) для сортировки
- Память: зависит от размера входных данных

## Логирование

### Уровни логирования
- **INFO**: Основные этапы обработки
- **WARNING**: Проблемы с данными
- **ERROR**: Критические ошибки

### Прогресс-логирование
- Поэтапное отображение (1/4, 2/4, 3/4, 4/4)
- Статистика по биржам
- Метрики качества

## Интеграция

### Входные блоки
- Блок 04: Синхронизация времени (синхронизированные depth данные)

### Выходные блоки
- Блок 08: Кросс-биржевая агрегация (NBBO)
- Блок 10: Фичи паттернов (анализ спредов)

## Устранение неполадок

### Частые проблемы
1. **Пустые quotes**: Проверить качество depth данных, уменьшить `tick_size_ms`
2. **Аномальные спреды**: Настроить `min_bid_ask_spread`, `max_bid_ask_spread`
3. **Низкое качество**: Проверить валидацию, увеличить `min_level_size`

### Отладка
- Включить детальное логирование
- Анализировать статистику по биржам
- Проверить метрики качества

## Будущие улучшения

### Планируемые функции
- Параллельная обработка бирж
- Адаптивные временные окна
- Машинное обучение для восстановления
- Поддержка большего количества источников

### Оптимизации
- Кэширование результатов
- Инкрементальное обновление
- Автоматическая настройка параметров
- Интеграция с real-time данными
