# Блок 04: Синхронизация времени

## Обзор
Блок синхронизации времени решает критическую задачу выравнивания временных меток между различными биржами и источниками данных. Это необходимо для корректного анализа рыночных событий и построения торговых стратегий.

## Назначение
- **Оценка лагов**: Определение временных задержек между биржами
- **Синхронизация**: Приведение всех данных к единой временной шкале
- **Фильтрация**: Удаление периодов с недостаточным покрытием данных
- **Валидация**: Проверка качества синхронизации

## Ключевые возможности

### 1. Оценка лагов между биржами
- Кросс-корреляционный анализ ценовых рядов
- Автоматический выбор референсной биржи
- Настраиваемые временные окна и пороги корреляции

### 2. Синхронизация временных меток
- Применение рассчитанных лагов к данным
- Поддержка различных типов данных (trades, depth)
- Сохранение исходных меток для аудита

### 3. Фильтрация дропов данных
- Выявление периодов с недостаточным покрытием
- Настраиваемые пороги минимального покрытия
- Логирование отфильтрованных периодов

### 4. Валидация качества
- Метрики покрытия данных
- Оценка временного выравнивания
- Проверка целостности данных

## Архитектура

### Основные функции
- `estimate_exchange_lags()` - Оценка лагов между биржами
- `sync_timestamps()` - Синхронизация временных меток
- `filter_drops()` - Фильтрация дропов данных
- `validate_sync_quality()` - Валидация качества
- `run_time_sync()` - Основная функция оркестрации

### Алгоритмы
1. **Временная агрегация**: Группировка данных по настраиваемым окнам
2. **Кросс-корреляция**: Поиск оптимального лага между биржами
3. **Применение сдвигов**: Корректировка временных меток
4. **Фильтрация**: Удаление некачественных периодов
5. **Валидация**: Расчет метрик качества

## Использование

### Базовый пример
```python
from oflow.blocks.sync_time import run_time_sync
import yaml

# Загрузка конфигурации
with open('configs/sync_time.yaml', 'r') as f:
    config = yaml.safe_load(f)

# Запуск синхронизации
synced_trades, synced_depth = run_time_sync(
    trades_df, depth_df, config
)
```

### Конфигурация
```yaml
sync_time:
  reference_exchange: "binance"
  max_lag_seconds: 10
  correlation_threshold: 0.7
  time_bucket_ms: 1000
  min_data_points: 50
  min_data_coverage: 0.8
  log_progress: true
```

## Структура данных

### Входные данные
- `trades_df`: DataFrame с колонками `exchange`, `ts_ns`, `price`, `size`
- `depth_df`: DataFrame с колонками `exchange`, `ts_ns`, `side`, `price`, `size`

### Выходные данные
- `synced_trades`: Синхронизированные trades данные
- `synced_depth`: Синхронизированные depth данные
- `quality_metrics`: Метрики качества синхронизации

## Метрики качества

### 1. Покрытие данных (Data Coverage)
- Доля временных окон с данными от всех бирж
- Порог: `min_data_coverage` (по умолчанию 0.8)

### 2. Временное выравнивание (Time Alignment)
- Скор выравнивания между биржами
- Порог: `min_alignment_score` (по умолчанию 0.85)

### 3. Целостность данных (Data Integrity)
- Проверка на дубликаты и монотонность
- Оценка временных интервалов

### 4. Общий скор качества
- Среднее арифметическое всех метрик
- Классификация: Отлично (≥0.9), Хорошо (≥0.7), Удовлетворительно (≥0.5), Плохо (<0.5)

## Производительность

### Оптимизации
- Батчевая обработка данных
- Настраиваемые временные окна
- Логирование прогресса для длительных операций

### Ограничения
- Требует достаточного количества данных для корреляции
- Временная сложность: O(n * m), где n - количество бирж, m - размер временного окна

## Логирование

### Уровни логирования
- **INFO**: Основные этапы синхронизации
- **WARNING**: Проблемы с данными или качеством
- **ERROR**: Критические ошибки

### Прогресс-логирование
- Поэтапное отображение прогресса (1/4, 2/4, 3/4, 4/4)
- Настраивается через `log_progress` в конфигурации

## Интеграция

### Входные блоки
- Блок 03: Нормализация (нормализованные данные)

### Выходные блоки
- Блок 05: Лучшие цены
- Блок 06: Топ-зона книги
- Блок 07: Trade Tape

## Устранение неполадок

### Частые проблемы
1. **Недостаточно данных**: Увеличить `min_data_points`
2. **Низкая корреляция**: Проверить качество данных, уменьшить `time_bucket_ms`
3. **Большие лаги**: Увеличить `max_lag_seconds`

### Отладка
- Включить детальное логирование
- Проверить метрики качества
- Анализировать распределение лагов

## Будущие улучшения

### Планируемые функции
- Параллельная обработка бирж
- Адаптивные временные окна
- Машинное обучение для оценки лагов
- Поддержка большего количества источников данных

### Оптимизации
- Кэширование результатов корреляции
- Инкрементальная синхронизация
- Автоматическая настройка параметров
