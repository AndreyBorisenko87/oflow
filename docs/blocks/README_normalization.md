# Блок 03: Нормализация

## Обзор
Блок "Нормализация" приводит данные с различных бирж к единому стандартизированному формату. Это критически важный этап для обеспечения совместимости данных между разными источниками и последующими блоками обработки.

## Назначение
- **Стандартизация колонок**: Приведение названий колонок к единому формату
- **Нормализация временных меток**: Конвертация в наносекунды
- **Унификация значений**: Стандартизация сторон сделок, типов ордеров
- **Валидация данных**: Проверка логичности и целостности
- **Подготовка к синхронизации**: Обеспечение совместимости форматов

## Ключевые возможности

### 1. Нормализация trades данных
- Стандартизация названий колонок (timestamp → ts_ns, amount → size)
- Конвертация временных меток в наносекунды
- Унификация сторон сделок (buy/sell, b/s, long/short)
- Стандартизация типов сделок (market/limit, m/l)
- Валидация цен и объемов

### 2. Нормализация depth данных
- Стандартизация названий колонок
- Конвертация временных меток
- Унификация сторон (bid/ask, b/a, buy/sell)
- Стандартизация типов обновлений (new/update/delete)
- Валидация данных order book

### 3. Автоматическое определение форматов
- Автоопределение формата временных меток
- Адаптация под специфику бирж
- Гибкая настройка маппингов
- Обработка различных форматов данных

### 4. Валидация качества
- Проверка обязательных колонок
- Валидация типов данных
- Контроль логичности значений
- Метрики качества нормализации

## Архитектура

### Основные функции
- `normalize_trades()` - Нормализация trades данных
- `normalize_depth()` - Нормализация depth данных
- `validate_normalized_data()` - Валидация качества
- `run_normalization()` - Основная функция оркестрации

### Алгоритмы
1. **Стандартизация колонок**: Маппинг названий к стандартным
2. **Конвертация времени**: Автоопределение и конвертация форматов
3. **Унификация значений**: Маппинг значений к стандартным
4. **Валидация**: Проверка логичности и целостности
5. **Сортировка**: Приведение к хронологическому порядку

## Использование

### Базовый пример
```python
from oflow.blocks.normalization import run_normalization
import yaml

# Загрузка конфигурации
with open('configs/normalization.yaml', 'r') as f:
    config = yaml.safe_load(f)

# Запуск нормализации
normalized_trades, normalized_depth = run_normalization(
    trades_df, depth_df, config
)
```

### Конфигурация
```yaml
normalization:
  log_progress: true
  trades:
    timestamp:
      target_format: "nanoseconds"
      auto_detect: true
    side:
      standardize: true
      allowed_values: ["buy", "sell"]
  depth:
    side:
      standardize: true
      allowed_values: ["bid", "ask"]
```

## Структура данных

### Входные данные
- `trades_df`: DataFrame с сырыми trades данными
- `depth_df`: DataFrame с сырыми depth данными

### Выходные данные
- `normalized_trades`: DataFrame с колонками:
  - `ts_ns`: Временная метка в наносекундах
  - `exchange`: Биржа
  - `price`: Цена
  - `size`: Объем
  - `side`: Сторона (buy/sell)
  - `type`: Тип сделки (market/limit)

- `normalized_depth`: DataFrame с колонками:
  - `ts_ns`: Временная метка в наносекундах
  - `exchange`: Биржа
  - `price`: Цена
  - `size`: Объем
  - `side`: Сторона (bid/ask)
  - `update_type`: Тип обновления (new/update/delete)

## Метрики качества

### 1. Полнота данных (Completeness)
- Наличие обязательных колонок
- Покрытие требуемых полей
- Цель: 100% для критических колонок

### 2. Валидность временных меток
- Корректность формата времени
- Конвертация в наносекунды
- Проверка диапазона значений

### 3. Логичность данных
- Цены > 0
- Объемы > 0 (для trades)
- Объемы >= 0 (для depth)
- Корректность сторон сделок

### 4. Стандартизация
- Унификация названий колонок
- Стандартизация значений
- Совместимость форматов

## Производительность

### Оптимизации
- Батчевая обработка данных
- Эффективные маппинги колонок
- Минимизация копирования данных

### Ограничения
- Временная сложность: O(n) для каждого DataFrame
- Память: требует копии данных для модификации
- Зависит от размера входных данных

## Логирование

### Уровни логирования
- **INFO**: Основные этапы нормализации
- **WARNING**: Проблемы с данными
- **ERROR**: Критические ошибки
- **DEBUG**: Детали маппинга колонок

### Прогресс-логирование
- Поэтапное отображение (1/3, 2/3, 3/3)
- Статистика по биржам
- Метрики качества

## Интеграция

### Входные блоки
- Блок 02: Импорт сырья (сырые данные)

### Выходные блоки
- Блок 04: Синхронизация времени
- Блок 05: Лучшие цены
- Блок 06: Топ-зона книги

## Устранение неполадок

### Частые проблемы
1. **Отсутствующие колонки**: Проверить маппинг в конфигурации
2. **Некорректные временные метки**: Настроить автоопределение формата
3. **Нестандартные значения**: Добавить маппинги в конфигурацию

### Отладка
- Включить детальное логирование
- Проверить маппинги колонок
- Анализировать метрики качества

## Будущие улучшения

### Планируемые функции
- Поддержка большего количества бирж
- Автоматическое определение схем данных
- Машинное обучение для нормализации
- Инкрементальная нормализация

### Оптимизации
- Параллельная обработка бирж
- Кэширование маппингов
- Автоматическая настройка параметров
- Интеграция с real-time данными
