# Блок 08: Кросс-биржевая агрегация

## Обзор

Модуль кросс-биржевой агрегации предназначен для синхронизации данных между биржами, построения NBBO (National Best Bid and Offer) и агрегации объемов для получения консенсусных метрик ликвидности.

## Функциональность

### 1. Синхронизация данных
- **Временная синхронизация**: выравнивание данных по временным меткам
- **Валидация лагов**: проверка допустимых задержек между биржами
- **Перекрытие данных**: обеспечение минимального перекрытия для анализа

### 2. Построение NBBO
- **Лучшие цены**: глобальные best bid и best ask среди всех бирж
- **Биржи-лидеры**: определение бирж с лучшими ценами
- **Валидация спредов**: проверка корректности bid/ask отношений
- **Метрики спредов**: абсолютные и относительные значения

### 3. Агрегация объемов
- **Суммарные объемы**: консолидация по биржам и времени
- **Консенсус цен**: оценка согласованности цен между биржами
- **Метрики ликвидности**: скоринг ликвидности и дисбалансы
- **Крупные сделки**: анализ влияния крупных операций

### 4. Дополнительные метрики
- **Скользящие средние**: для спредов и объемов
- **Волатильность**: изменения цен и спредов
- **Конвергенция бирж**: анализ сближения цен
- **Тренды объемов**: направление изменения ликвидности

## Структура данных

### Входные данные

#### Котировки (quotes_df)
```python
quotes_df = pd.DataFrame({
    'ts_ns': int,           # Временная метка в наносекундах
    'exchange': str,         # Биржа
    'symbol': str,           # Символ
    'bid': float,            # Цена покупки
    'ask': float,            # Цена продажи
    'bid_size': float,       # Объем покупки
    'ask_size': float        # Объем продажи
})
```

#### Сделки (trades_df)
```python
trades_df = pd.DataFrame({
    'ts_ns': int,           # Временная метка в наносекундах
    'exchange': str,         # Биржа
    'symbol': str,           # Символ
    'price': float,          # Цена сделки
    'size': float,           # Размер сделки
    'side': str              # Сторона (buy/sell)
})
```

### Выходные данные

#### NBBO (nbbo_df)
```python
# Основные метрики
'ts_ns': int,                    # Временная метка
'symbol': str,                    # Символ
'best_bid': float,               # Лучшая цена покупки
'best_ask': float,               # Лучшая цена продажи
'best_bid_size': float,          # Объем лучшего bid
'best_ask_size': float,          # Объем лучшего ask
'mid_price': float,               # Средняя цена
'spread': float,                  # Абсолютный спред
'sread_pct': float,               # Относительный спред (%)

# Биржи-лидеры
'bid_exchange': str,              # Биржа с лучшим bid
'ask_exchange': str,              # Биржа с лучшим ask

# Объемные метрики
'total_bid_volume': float,        # Суммарный объем bid
'total_ask_volume': float,        # Суммарный объем ask
'volume_imbalance': float,        # Дисбаланс объемов

# Дополнительные метрики
'spread_ma_5': float,             # Скользящее среднее спреда (5)
'spread_ma_20': float,            # Скользящее среднее спреда (20)
'spread_volatility': float,       # Волатильность спреда
'mid_price_change': float,        # Изменение средней цены
'mid_price_change_pct': float,    # Изменение средней цены (%)
'exchange_convergence': float     # Конвергенция бирж
```

#### Агрегированные объемы (volume_df)
```python
# Основные метрики
'ts_ns': int,                     # Временная метка
'symbol': str,                     # Символ
'total_volume': float,             # Суммарный объем
'total_value': float,              # Суммарная стоимость
'vwap': float,                     # VWAP
'price_consensus': float,          # Консенсус цен

# Метрики ликвидности
'liquidity_score': float,          # Скоринг ликвидности
'volume_imbalance': float,         # Дисбаланс объемов
'buy_volume': float,               # Объем покупок
'sell_volume': float,              # Объем продаж

# Дополнительные метрики
'large_trades_ratio': float,       # Доля крупных сделок
'trade_count': int,                # Количество сделок
'exchange_count': int,             # Количество бирж
'exchanges': str,                  # Список бирж

# Скользящие средние
'volume_ma_5': float,              # Скользящее среднее объема (5)
'volume_ma_20': float,             # Скользящее среднее объема (20)
'volume_ratio_5': float,           # Отношение к MA5
'volume_ratio_20': float,          # Отношение к MA20
'volume_trend': int                # Тренд объемов (-1, 0, 1)
```

## Использование

### Базовое использование
```python
from oflow.blocks.cross_exchange import run_cross_exchange
import yaml

# Загрузка конфигурации
with open('configs/cross_exchange.yaml', 'r') as f:
    config = yaml.safe_load(f)

# Кросс-биржевая агрегация
nbbo_df, volume_df = run_cross_exchange(quotes_df, trades_df, config)
```

### Продвинутое использование
```python
from oflow.blocks.cross_exchange import CrossExchangeAggregator

# Создание агрегатора
aggregator = CrossExchangeAggregator(config)

# Полный анализ с прогресс-логированием
nbbo_df, volume_df = aggregator.run_cross_exchange_analysis(quotes_df, trades_df)
```

## Конфигурация

### Основные параметры
```yaml
# Синхронизация
sync:
  max_lag_ms: 5000              # Максимальный лаг между биржами
  min_overlap_ratio: 0.8        # Минимальное перекрытие данных

# NBBO
nbbo:
  min_spread_pct: 0.001         # Минимальный спред
  validate_crosses: true        # Валидация пересечений

# Объемы
volumes:
  liquidity_score_window: 20    # Окно для скоринга ликвидности
  large_trade_multiplier: 2.0   # Множитель крупных сделок
```

## Алгоритмы

### Синхронизация данных
1. **Временные группы**: группировка по тикам времени
2. **Валидация лагов**: проверка допустимых задержек
3. **Перекрытие данных**: обеспечение минимального покрытия

### Построение NBBO
1. **Поиск лучших цен**: максимум bid, минимум ask среди всех бирж
2. **Валидация спредов**: проверка bid < ask
3. **Определение лидеров**: биржи с лучшими ценами
4. **Вычисление метрик**: спреды, объемы, дисбалансы

### Агрегация объемов
1. **Временная группировка**: агрегация по тикам
2. **Биржевая агрегация**: суммирование по биржам
3. **Консенсус цен**: оценка согласованности
4. **Метрики ликвидности**: скоринг и дисбалансы

### Дополнительные метрики
1. **Скользящие средние**: для спредов и объемов
2. **Волатильность**: стандартные отклонения
3. **Тренды**: направление изменений
4. **Конвергенция**: сближение цен между биржами

## Экспорт данных

### Основные файлы
- `nbbo_aggregated.parquet` - полный NBBO с метриками
- `volumes_aggregated.parquet` - агрегированные объемы
- `exchange_nbbo_summary.parquet` - сводка по биржам
- `exchange_volumes_summary.parquet` - сводка объемов по биржам
- `hourly_summary.parquet` - почасовая агрегация

### Формат данных
- **Parquet** с сжатием Snappy
- **Индексация** по времени и символам
- **Оптимизация** для быстрого чтения и анализа

## Производительность

### Оптимизации
- **Векторизованные операции** pandas/numpy
- **Временная группировка** для эффективной синхронизации
- **Пакетная обработка** больших объемов данных
- **Оптимизированные алгоритмы** для NBBO

### Ограничения
- **Память**: требует загрузки всех данных в память
- **Время**: O(n * e) где n - количество записей, e - количество бирж
- **Синхронизация**: зависит от качества временных меток

## Примеры использования

### Анализ NBBO
```python
# Анализ спредов по биржам
spread_analysis = nbbo_df.groupby(['bid_exchange', 'ask_exchange']).agg({
    'spread_pct': 'mean',
    'volume_imbalance': 'mean',
    'best_bid_size': 'mean',
    'best_ask_size': 'mean'
})
```

### Анализ ликвидности
```python
# Фильтрация высоколиквидных периодов
high_liquidity = volume_df[volume_df['liquidity_score'] > 0.8]

# Анализ дисбалансов
imbalance_analysis = volume_df.groupby('exchanges').agg({
    'volume_imbalance': 'mean',
    'large_trades_ratio': 'mean',
    'total_volume': 'sum'
})
```

### Кросс-биржевой анализ
```python
# Объединение NBBO и объемов
combined_analysis = nbbo_df.merge(
    volume_df[['ts_ns', 'total_volume', 'liquidity_score']],
    on='ts_ns',
    how='inner'
)

# Корреляция спредов и ликвидности
correlation = combined_analysis['spread_pct'].corr(combined_analysis['liquidity_score'])
```

## Логирование

### Уровни логирования
- **INFO**: основные этапы агрегации
- **DEBUG**: детальный прогресс по временным группам
- **WARNING**: проблемы с синхронизацией
- **ERROR**: ошибки выполнения

### Прогресс-логирование
- **По временным группам**: каждые 1000 групп
- **По этапам**: 4 основных этапа анализа
- **Время выполнения**: для каждого этапа и общего процесса
- **Статистика**: количество записей NBBO и объемов
